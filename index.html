<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SW2.5 ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«</title>

<!-- â–¼ PWAè¨­å®š -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="dice-icon.png">
<!-- â–² PWAè¨­å®š -->

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #1e2530;
  color: #fff;
  text-align: center;
  padding: 20px;
}
h1 {
  font-size: 1.5em;
  margin-bottom: 15px;
}
button, select, input {
  font-size: 1.1em;
  margin: 5px;
  padding: 10px 15px;
  border-radius: 8px;
  border: none;
  background: #3b82f6;
  color: white;
}
button:hover, select:hover, input:hover {
  opacity: 0.9;
}
input {
  width: 140px;
  text-align: center;
  background: #374151;
}
#log {
  background: #111827;
  border-radius: 10px;
  padding: 10px;
  margin-top: 15px;
  text-align: left;
  max-height: 300px;
  overflow-y: auto;
}
#clearLog {
  background: #ef4444;
}
.result {
  font-weight: bold;
  color: #38bdf8;
}
.crit {
  color: #facc15;
  font-weight: bold;
}
.fumble {
  color: #f87171;
  font-weight: bold;
}
</style>
</head>
<body>
<h1>SW2.5 ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«</h1>

<!-- å›ºå®šãƒœã‚¿ãƒ³ -->
<div id="diceButtons">
  <button onclick="roll('2d6')">2d6</button>
  <button onclick="roll('2d6+3')">2d6+3</button>
  <button onclick="roll('2d6+4')">2d6+4</button>
  <button onclick="roll('2d6+5')">2d6+5</button>
  <button onclick="roll('2d6+6')">2d6+6</button>
  <button onclick="roll('2d6+7')">2d6+7</button>
  <button onclick="roll('2d6+8')">2d6+8</button>
</div>

<!-- ä»»æ„ãƒ€ã‚¤ã‚¹å¼ -->
<div style="margin-top:15px;">
  <input type="text" id="customInput" placeholder="ä¾‹: 3d6+2d4+5" />
  <button onclick="rollCustom()">ãƒ­ãƒ¼ãƒ«</button>
</div>

<h2>ãƒ­ã‚°</h2>
<div id="log"></div>
<button id="clearLog" onclick="clearLog()">ãƒ­ã‚°å‰Šé™¤</button>

<script>
// â–¼ ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«å‡¦ç†ï¼ˆè¤‡åˆå¼å¯¾å¿œï¼‰
function roll(expression) {
  // å¼ã‚’åˆ†è§£
  const dicePattern = /([+-]?\d*)d(\d+)/gi;
  let total = 0;
  let rollsText = [];
  let match;
  let expr = expression.replace(/\s+/g, '');

  while ((match = dicePattern.exec(expr)) !== null) {
    const sign = match[1].startsWith('-') ? -1 : 1;
    const num = Math.abs(parseInt(match[1])) || 1;
    const sides = parseInt(match[2]);
    let rolls = [];
    for (let i = 0; i < num; i++) {
      rolls.push(Math.floor(Math.random() * sides) + 1);
    }
    const sum = rolls.reduce((a,b)=>a+b,0) * sign;
    total += sum;
    rollsText.push(`${sign===-1?"-":""}[${rolls.join(", ")}]`);
  }

  // ãƒœãƒ¼ãƒŠã‚¹/ãƒšãƒŠãƒ«ãƒ†ã‚£å‡¦ç†
  const rest = expr.replace(dicePattern, '');
  if (rest) {
    const bonusParts = rest.match(/[+-]\d+/g);
    if (bonusParts) {
      bonusParts.forEach(v => total += parseInt(v));
      rollsText.push(rest);
    }
  }

  // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ»ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«åˆ¤å®šï¼ˆ2d6ã®ã¨ãã®ã¿ï¼‰
  let special = "";
  if (/^2d6(\+\d+)?$/i.test(expression.trim())) {
    const justRoll = rollsText[0].replace(/[^0-9,]/g,'').split(',').map(Number);
    const sum = justRoll.reduce((a,b)=>a+b,0);
    if (sum === 12) special = " ğŸ’¥<span class='crit'>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼</span>";
    if (sum === 2) special = " ğŸ’€<span class='fumble'>ãƒ•ã‚¡ãƒ³ãƒ–ãƒ«ï¼</span>";
  }

  const time = new Date().toLocaleTimeString("ja-JP",{hour12:false});
  const resultText = `[${time}] ${expression} â†’ ${rollsText.join(" ")} = <span class="result">${total}</span>${special}`;
  addLog(resultText);
}

// â–¼ ä»»æ„å¼ãƒ­ãƒ¼ãƒ«
function rollCustom() {
  const val = document.getElementById("customInput").value;
  if (!val) return;
  roll(val);
}

// â–¼ ãƒ­ã‚°ç®¡ç†
function addLog(text) {
  const log = document.getElementById("log");
  const entry = document.createElement("div");
  entry.innerHTML = text;
  log.prepend(entry);
  saveLog();
}
function saveLog() {
  localStorage.setItem("sw25_dice_log", document.getElementById("log").innerHTML);
}
function loadLog() {
  const saved = localStorage.getItem("sw25_dice_log");
  if (saved) document.getElementById("log").innerHTML = saved;
}
function clearLog() {
  if (confirm("ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    document.getElementById("log").innerHTML = "";
    localStorage.removeItem("sw25_dice_log");
  }
}

// åˆæœŸåŒ–
loadLog();

// â–¼ PWA Service Worker ç™»éŒ²
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js');
  });
}
</script>
</body>
</html>
