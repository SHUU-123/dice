<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SW2.5 ダイスロール（PWA対応）</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="icon-192.png">

<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --muted:#98a0b3; --accent:#8bd5ff;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; background:linear-gradient(180deg,var(--bg),#07101a); color:#e6eef8;}
  .app{max-width:980px;margin:18px auto;padding:18px;}
  header{display:flex;gap:12px;align-items:center}
  h1{margin:0;font-size:1.2rem}
  .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,0.5); margin-top:12px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:inherit;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button:active{transform:translateY(1px)}
  .preset-row{display:flex;gap:8px;flex-wrap:wrap}
  .select, .input {padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .custom-row{display:flex;gap:8px;align-items:center;margin-top:10px}
  .log{margin-top:14px;max-height:300px;overflow:auto;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px}
  .entry{display:flex;justify-content:space-between;gap:12px;padding:8px;border-radius:6px;margin-bottom:8px;background:rgba(255,255,255,0.012);align-items:center}
  .meta{color:var(--muted);font-size:0.85rem}
  .dice-list{font-weight:700}
  .badge{padding:4px 8px;border-radius:999px;font-size:0.85rem}
  .crit{background:#ffb3b3;color:#5a0000}
  .fumble{background:#ffd8a8;color:#663a00}
  .secondary{background:rgba(255,255,255,0.02)}
  .controls-bottom{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .clear-all{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--muted)}
  footer{margin-top:14px;color:var(--muted);font-size:0.85rem;text-align:right}
  @media (max-width:640px){ .controls{flex-direction:column;align-items:stretch} .preset-row{width:100%;} .custom-row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="app">
  <header>
    <img src="icon-192.png" alt="" width="44" height="44" style="border-radius:8px">
    <div>
      <h1>SW2.5 ダイスロール（PWA対応）</h1>
      <div class="meta">2d6系プリセット / 1d1〜1d100 プルダウン / カスタムダイス / ログ永続化</div>
    </div>
  </header>

  <section class="panel">
    <div class="controls">
      <div style="flex:1">
        <div class="preset-row" id="presetRow">
          <!-- プリセットボタン -->
        </div>
        <div style="margin-top:8px" class="meta">※ 2d6 系はクリティカル／ファンブルを自動判定します（1d1〜1d100はしません）</div>
      </div>

      <div style="width:240px">
        <label class="meta">1d1 〜 1d100</label>
        <select id="d1to100" class="select" style="width:100%;margin-top:6px"></select>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="rollD1to100">ロール</button>
          <button id="addToLogFromD100" class="secondary">結果をログに残す</button>
        </div>
      </div>
    </div>

    <div class="custom-row">
      <div style="display:flex;gap:8px;align-items:center">
        <label class="meta">カスタムダイス</label>
        <input id="customN" type="number" class="input" placeholder="N (個数)" min="1" value="1" style="width:90px">
        <span style="font-weight:700">d</span>
        <input id="customM" type="number" class="input" placeholder="M (面数)" min="1" value="6" style="width:110px">
        <input id="customMod" type="number" class="input" placeholder="修正 (例 +3/-2)" value="0" style="width:120px">
        <button id="rollCustom">ロール</button>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <div id="lastResult" class="meta">—</div>
      </div>
    </div>

    <div class="controls-bottom">
      <div style="flex:1">
        <div style="font-weight:700">最新 — <span id="lastSummary">まだ振られていません</span></div>
        <div class="meta" id="lastDetail"></div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="copyLast">結果をコピー</button>
        <button id="downloadLog">ログをJSONでダウンロード</button>
        <button id="importLog">ログをJSONから復元</button>
      </div>
    </div>

    <div class="log" id="log"></div>

    <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
      <button id="clearAll" class="clear-all">ログ全削除</button>
    </div>

    <footer>保存場所: ブラウザの localStorage（削除しない限り残ります）</footer>
  </section>
</div>

<script>
/* ---------- ヘルパー ---------- */
function fmtTime(ts){
  const d = new Date(ts);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0')
    + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0');
}
function randInt(min, max){ // inclusive
  return Math.floor(Math.random()*(max-min+1))+min;
}

/* ---------- ログ管理 ---------- */
const STORAGE_KEY = 'sw25_dice_log_v1';
let logData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

function saveLog(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(logData));
}
function addLog(entry){
  logData.unshift(entry); // 最新を先頭
  saveLog();
  renderLog();
}

/* ---------- UI準備 ---------- */
const presetRow = document.getElementById('presetRow');
const d1to100 = document.getElementById('d1to100');
const logEl = document.getElementById('log');
const lastSummary = document.getElementById('lastSummary');
const lastDetail = document.getElementById('lastDetail');
const lastResult = document.getElementById('lastResult');

function makePresetButtons(){
  const presets = [
    {label:'2d6', expr:'2d6', mod:0},
    {label:'2d6+3', expr:'2d6+3', mod:3},
    {label:'2d6+4', expr:'2d6+4', mod:4},
    {label:'2d6+5', expr:'2d6+5', mod:5},
    {label:'2d6+6', expr:'2d6+6', mod:6},
    {label:'2d6+7', expr:'2d6+7', mod:7},
    {label:'2d6+8', expr:'2d6+8', mod:8},
  ];
  presets.forEach(p=>{
    const b = document.createElement('button');
    b.textContent = p.label;
    b.addEventListener('click', ()=> roll2d6(p.mod));
    presetRow.appendChild(b);
  });
}

function populateD1to100(){
  for(let i=1;i<=100;i++){
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = '1d' + i;
    d1to100.appendChild(opt);
  }
}

/* ---------- ロール処理 ---------- */
function roll2d6(mod=0){
  // SW2.5判定: 2d6 のクリティカル・ファンブル判定
  const dice = [randInt(1,6), randInt(1,6)];
  const total = dice[0] + dice[1] + mod;
  // クリティカル：2個とも6 → クリティカル（原則で最大値）
  // ファンブル：2個とも1 → ファンブル
  let judgement = null;
  if(dice[0] === 6 && dice[1] === 6) judgement = 'critical';
  else if(dice[0] === 1 && dice[1] === 1) judgement = 'fumble';
  const entry = {
    ts: Date.now(),
    type: '2d6',
    expr: `2d6${mod? (mod>0? '+'+mod: mod): ''}`,
    dice,
    mod,
    total,
    judgement
  };
  lastSummary.textContent = `${entry.expr} → ${total}` + (judgement? ` (${judgement})`:'');
  lastDetail.textContent = `個別: [${dice.join(', ')}] 修正: ${mod>=0? '+'+mod: mod}  取得時刻: ${fmtTime(entry.ts)}`;
  lastResult.textContent = total;
  addLog(entry);
}

function rollD1to100(){
  const m = parseInt(d1to100.value,10) || 100;
  const v = randInt(1,m);
  const entry = {
    ts: Date.now(),
    type: '1dN',
    expr: `1d${m}`,
    dice: [v],
    mod: 0,
    total: v,
    judgement: null // 指定通り判定不要
  };
  lastSummary.textContent = `${entry.expr} → ${v}`;
  lastDetail.textContent = `個別: [${v}] 取得時刻: ${fmtTime(entry.ts)}`;
  lastResult.textContent = v;
  addLog(entry);
}

function rollCustom(){
  const n = Math.max(1, parseInt(document.getElementById('customN').value || 1,10));
  const m = Math.max(1, parseInt(document.getElementById('customM').value || 6,10));
  const mod = parseInt(document.getElementById('customMod').value || 0,10);
  const dice = [];
  for(let i=0;i<n;i++) dice.push(randInt(1,m));
  const total = dice.reduce((a,b)=>a+b,0) + mod;
  // クリティカル/ファンブル判定について：
  // 要件では "1d1〜1d100は判定しなくていい" とあるため、
  // クリティカル/ファンブルはデフォルトで 2d6 系のみ自動判定します。
  // カスタムが「2d6」の場合は判定する（利便性のため）
  let judgement = null;
  if(n===2 && m===6){
    if(dice[0]===6 && dice[1]===6) judgement='critical';
    else if(dice[0]===1 && dice[1]===1) judgement='fumble';
  }
  const entry = {
    ts: Date.now(),
    type: 'custom',
    expr: `${n}d${m}${mod? (mod>0? '+'+mod: mod): ''}`,
    dice,
    mod,
    total,
    judgement
  };
  lastSummary.textContent = `${entry.expr} → ${total}` + (judgement? ` (${judgement})`:'');
  lastDetail.textContent = `個別: [${dice.join(', ')}] 修正: ${mod>=0? '+'+mod: mod} 取得時刻: ${fmtTime(entry.ts)}`;
  lastResult.textContent = total;
  addLog(entry);
}

/* ---------- ログ描画 ---------- */
function renderLog(){
  logEl.innerHTML = '';
  if(logData.length === 0){
    logEl.innerHTML = '<div class="meta">ログは空です</div>';
    return;
  }
  logData.forEach((e, idx)=>{
    const div = document.createElement('div');
    div.className = 'entry';
    const left = document.createElement('div');
    const title = document.createElement('div');
    title.innerHTML = `<div style="font-weight:800">${e.expr} → ${e.total}</div>`;
    const sub = document.createElement('div');
    sub.className = 'meta';
    sub.innerHTML = `個別: <span class="dice-list">[${e.dice.join(', ')}]</span> 修正: ${e.mod>=0? '+'+e.mod: e.mod} ・ ${fmtTime(e.ts)}`;
    left.appendChild(title);
    left.appendChild(sub);

    const right = document.createElement('div');
    right.style.display='flex';
    right.style.gap='8px';
    right.style.alignItems='center';

    if(e.judgement){
      const b = document.createElement('div');
      b.className = 'badge ' + (e.judgement === 'critical' ? 'crit' : 'fumble');
      b.textContent = e.judgement === 'critical' ? 'クリティカル' : 'ファンブル';
      right.appendChild(b);
    }

    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'コピー';
    copyBtn.addEventListener('click', ()=> {
      navigator.clipboard?.writeText(`${e.expr} => ${e.total} [${e.dice.join(', ')}] ${e.judgement? ' ' + e.judgement : ''}`).then(()=> {
        copyBtn.textContent = 'コピー済';
        setTimeout(()=>copyBtn.textContent='コピー',900);
      });
    });

    const delBtn = document.createElement('button');
    delBtn.textContent = '削除';
    delBtn.addEventListener('click', ()=> {
      if(!confirm('このログを削除しますか？')) return;
      logData.splice(idx,1);
      saveLog();
      renderLog();
    });

    right.appendChild(copyBtn);
    right.appendChild(delBtn);

    div.appendChild(left);
    div.appendChild(right);
    logEl.appendChild(div);
  });
}

/* ---------- イベントバインド ---------- */
document.getElementById('rollD1to100').addEventListener('click', rollD1to100);
document.getElementById('rollCustom').addEventListener('click', rollCustom);
document.getElementById('copyLast').addEventListener('click', ()=>{
  if(lastSummary.textContent === 'まだ振られていません') return alert('まだ振られていません');
  navigator.clipboard?.writeText(lastSummary.textContent).then(()=> alert('コピーしました'));
});
document.getElementById('downloadLog').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(logData,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'sw25_dice_log.json';
  a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('importLog').addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.addEventListener('change', async (ev)=>{
    const f = ev.target.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      if(!Array.isArray(parsed)) throw new Error('配列でありません');
      // マージして保存（先頭にインポート分を追加）
      logData = parsed.concat(logData);
      saveLog();
      renderLog();
      alert('インポートしました');
    }catch(err){
      alert('読み込みに失敗しました: ' + err.message);
    }
  });
  input.click();
});
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(!confirm('ログをすべて削除しますか？この操作は取り消せません')) return;
  logData = [];
  saveLog();
  renderLog();
});

/* ---------- 初期化 ---------- */
makePresetButtons();
populateD1to100();
renderLog();

/* ---------- 表示からログに追加する（1dNのボタンの隣にあるやつ） ---------- */
document.getElementById('addToLogFromD100').addEventListener('click', ()=> {
  // 既に rollD1to100 が値を出していればその直近値をもう一度ログに入れる（手動追加）
  // ここでは簡易的に単発でロールしてログ保存
  rollD1to100();
});

/* ---------- Service Worker登録（PWA） ---------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=> {
    console.log('SW registered');
  }).catch(err=>console.warn('SW failed', err));
}

/* ---------- 初回説明が欲しければローカル通知？ 省略 ---------- */

</script>
</body>
</html>
